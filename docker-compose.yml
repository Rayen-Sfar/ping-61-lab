services:

  # ============================================================================
  # MYSQL FOR GUACAMOLE
  # ============================================================================
  mysql:
    image: mysql:8.0
    container_name: ping61-mysql
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: guacamole
      MYSQL_USER: ${GUAC_DB_USER}
      MYSQL_PASSWORD: ${GUAC_DB_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./scripts/guacamole-init.sql:/docker-entrypoint-initdb.d/01-guacamole-init.sql
    ports:
      - "3306:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # DATABASE
  # ============================================================================
  postgres:
    image: postgres:15-alpine
    container_name: ping61-postgres
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/01-init.sql
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # BACKEND API (FastAPI)
  # ============================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ping61-backend
    environment:
      # ✅ CAS Configuration
      CAS_SERVER_URL: http://cas:8080
      CAS_SERVER_URL_PUBLIC: http://localhost:8888
      CAS_SERVICE_URL: http://localhost:3000
      
      # Database
      DATABASE_URL: postgresql://${DB_USER}:${DB_PASSWORD}@postgres:5432/${DB_NAME}
      
      # JWT
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      JWT_ALGORITHM: HS256
      JWT_EXPIRE_MINUTES: 60
      
      # Proxmox
      PROXMOX_HOST: ${PROXMOX_HOST}
      PROXMOX_USER: ${PROXMOX_USER}
      PROXMOX_PASSWORD: ${PROXMOX_PASSWORD}
      
      # Guacamole
      GUACAMOLE_API_URL: http://guacamole:8080/guacamole
      # Public URL accessible by browser/host (maps container 8080 -> host 8088)
      # Changez cette adresse si votre hôte Guacamole est sur une IP différente
      GUACAMOLE_PUBLIC_URL: http://10.3.0.76:8080/guacamole
      GUACAMOLE_ADMIN_USERNAME: guacadmin
      GUACAMOLE_ADMIN_PASSWORD: guacadmin
      
      # Server
      LOG_LEVEL: INFO
    ports:
      - "8000:8000"
    depends_on:
      - postgres
      - cas
    volumes:
      - ./backend:/app
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload

  # ============================================================================
  # FRONTEND (React)
  # ============================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: ping61-frontend
    environment:
      # ✅ CAS & API
      REACT_APP_API_URL: http://backend:8000
      REACT_APP_CAS_LOGIN_URL: ${CAS_LOGIN_URL}
      REACT_APP_GUAC_BASE: ${GUACAMOLE_PUBLIC_URL}
    ports:
      - "3000:3000"
    depends_on:
      - backend
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
    command: npm start

  # ============================================================================
  # NGINX (Reverse Proxy + HTTPS)
  # ============================================================================
  nginx:
    image: nginx:alpine
    container_name: ping61-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl/:/etc/nginx/ssl/:ro
    depends_on:
      - backend
      - frontend
      - guacamole

  # ============================================================================
  # APACHE GUACAMOLE
  # ============================================================================
  guacamole:
    image: guacamole/guacamole:latest
    container_name: ping61-guacamole
    environment:
      GUACD_HOSTNAME: guacd
      GUACD_PORT: 4822
      MYSQL_HOSTNAME: mysql
      MYSQL_DATABASE: guacamole
      MYSQL_USER: ${GUAC_DB_USER}
      MYSQL_PASSWORD: ${GUAC_DB_PASSWORD}
    ports:
      - "8088:8080"
    depends_on:
      mysql:
        condition: service_healthy
      guacd:
        condition: service_started
  # GUACD (VNC/RDP Encoder)
  # ============================================================================
  guacd:
    image: guacamole/guacd:latest
    container_name: ping61-guacd
    ports:
      - "4822:4822"

  # ============================================================================
  # LDAP SERVER
  # ============================================================================
  openldap:
    image: osixia/openldap:1.5.0
    container_name: ping61-openldap
    environment:
      LDAP_ORGANISATION: "ESIGELEC"
      LDAP_DOMAIN: "esigelec.fr"
      LDAP_ADMIN_PASSWORD: "admin"
      LDAP_CONFIG_PASSWORD: "config"
    ports:
      - "389:389"
      - "636:636"
    volumes:
      - ldap_data:/var/lib/ldap
      - ldap_config:/etc/ldap/slapd.d
    healthcheck:
      test: ["CMD", "ldapsearch", "-x", "-H", "ldap://localhost", "-b", "dc=esigelec,dc=fr", "-D", "cn=admin,dc=esigelec,dc=fr", "-w", "admin"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # LDAP ACCOUNT MANAGER (Interface Web pour gérer LDAP)
  # ============================================================================
  lam:
    image: ldapaccountmanager/lam:latest
    container_name: ping61-lam
    depends_on:
      openldap:
        condition: service_healthy
    ports:
      - "8081:80"
    environment:
      LDAP_SERVER: "ldap://openldap:389"
      LDAP_DOMAIN: "dc=esigelec,dc=fr"
      LDAP_BASE_DN: "dc=esigelec,dc=fr"

  # ============================================================================
  # CAS SERVER SIMPLE (Mock pour développement)
  # ============================================================================
  cas:
    build:
      context: ./cas-mock
      dockerfile: Dockerfile
    container_name: ping61-cas
    depends_on:
      openldap:
        condition: service_healthy
    ports:
      - "8888:8080"
    environment:
      LDAP_HOST: openldap
      LDAP_PORT: 389
      LDAP_BASE_DN: dc=esigelec,dc=fr
      LDAP_ADMIN_DN: cn=admin,dc=esigelec,dc=fr
      LDAP_ADMIN_PASSWORD: admin
    volumes:
      - ./cas-mock:/app
    command: python app.py

volumes:
  postgres_data:
  mysql_data:
  ldap_data:
  ldap_config:

networks:
  default:
    name: ping61-network